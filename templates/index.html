<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Packet Sniffer Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            transition: background-color 0.5s, color 0.5s;
        }

        .dark-mode {
            background-color: #121212;
            color: #ffffff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 8px;
            border: 1px solid #ccc;
        }

        th {
            background-color: #007BFF;
            color: white;
        }

        .button-group {
            margin-top: 20px;
        }

        button {
            padding: 10px;
            margin-right: 10px;
            cursor: pointer;
        }

        .toggle-mode {
            float: right;
            margin-bottom: 10px;
        }

        #chart-container {
            margin-top: 30px;
        }

        h3 {
            margin-top: 30px;
        }

        #status-message {
            font-weight: bold;
            color: green;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <button class="toggle-mode" onclick="toggleMode()">ðŸŒ™ Toggle Dark/Light</button>
    <h1>Custom Packet Sniffer Dashboard</h1>

    <!-- Filter Form (GET) -->
    <form method="get" action="/">
        <label for="protocol_filter">Filter by Protocol:</label>
        <select name="protocol_filter" id="protocol_filter">
            <option value="">-- All --</option>
            <option value="TCP">TCP</option>
            <option value="UDP">UDP</option>
            <option value="ICMP">ICMP</option>
        </select>
        <button type="submit">Apply Filter</button>
    </form>

    <!-- Sniffer Form (POST) -->
    <form method="post" action="/start-sniff" onsubmit="return showSniffMessage();">
        <label for="packet_count">Packet Count:</label>
        <input type="number" name="packet_count" id="packet_count" value="20" min="1">
        <button type="submit">Start Sniffing</button>
        <a href="/download-csv"><button type="button">Download CSV</button></a>
    </form>

    <!-- Status Message -->
    <div id="status-message">
        {% if success_message %}
            {{ success_message }}
        {% endif %}
    </div>

    <!-- Sender & Receiver -->
    <div class="button-group">
        <button onclick="startSender()">Start Sender</button>
        <button onclick="startReceiver()">Start Receiver</button>
    </div>

    <!-- Live Packet Count -->
    <div>
        <h3>Live Packet Count: <span id="packet-count">0</span></h3>
    </div>

    <!-- Chart -->
    <div id="chart-container">
        {% if graphJSON %}
        <script>
            var graphData = {{ graphJSON | safe }};
            Plotly.newPlot('chart-container', graphData.data, graphData.layout);
        </script>
        {% else %}
        <p>No chart data available.</p>
        {% endif %}
    </div>

    <!-- Table -->
    <h2>Recent Packets</h2>
    {% if packets %}
    <table>
        <thead>
            <tr>
                {% for col in packets[0].keys() %}
                    <th>{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for pkt in packets %}
            <tr>
                {% for val in pkt.values() %}
                    <td>{{ val }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No packets found. Start sniffing to see data.</p>
    {% endif %}

    <!-- JS Functions -->
    <script>
        function toggleMode() {
            document.body.classList.toggle("dark-mode");
        }

        function startSender() {
            fetch('/start-sender')
                .then(response => response.text())
                .then(data => alert(data));
        }

        function startReceiver() {
            fetch('/start-receiver')
                .then(response => response.text())
                .then(data => alert(data));
        }

        function updatePacketCount() {
            fetch('/packet-count')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('packet-count').innerText = data.count;
                });
        }

        function showSniffMessage() {
            const count = document.getElementById('packet_count').value;
            const msgDiv = document.getElementById('status-message');
            msgDiv.innerText = `${count} packets captured successfully`;
            return true; // Allow form submission
        }

        setInterval(updatePacketCount, 1000);
    </script>
</body>
</html>
